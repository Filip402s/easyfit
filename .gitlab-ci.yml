image: tiangolo/docker-with-compose

services:
  - docker:19.03.1-dind

before_script:
  # - curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
  # - apt install nodejs
  # - sudo apt install nodejs

stages:
  - pre-check
  - cleanup
  - build
  - deploy

precheck-prod:
  stage: pre-check
  script:
    - docker --version
    - docker ps -a
    - docker-compose --version
    - ls -al
  only:
    - master

cleanup-prod:
  stage: cleanup
  script:
    - docker rmi easyfit_app-client --force
    - docker rmi easyfit_app-server --force
    - docker stack rm easyFitStack
    - docker-compose stop
  only:
    - master


build-prod:
  stage: build
  script:
    - echo y | docker-compose --file docker-compose.yml build # todo check if docker-stack works and should be used
  only:
    - master

deploy-prod:
  stage: deploy # todo rename to build and deploy
  script:
    - pwd
    - ls -al
    - ls *
    # - echo y | docker-compose --file docker-compose.yml build
    - echo y | docker stack deploy -c docker-stack.yml easyFitStack
  only:
    - master